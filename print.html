<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>nixos-anywhere - install NixOS everywhere</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="quickstart.html">Quickstart</a></li><li class="chapter-item expanded affix "><a href="requirements.html">System Requirements</a></li><li class="chapter-item expanded affix "><a href="howtos.html">How to Guide</a></li><li class="chapter-item expanded affix "><a href="supportmatrix.html">Support Matrix</a></li><li class="chapter-item expanded affix "><a href="reference.html">Reference</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">nixos-anywhere - install NixOS everywhere</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="quickstart-guide-nixos-anywhere"><a class="header" href="#quickstart-guide-nixos-anywhere">Quickstart Guide: nixos-anywhere</a></h1>
<p><strong><em>Install NixOS everywhere via ssh</em></strong></p>
<img src="https://raw.githubusercontent.com/numtide/nixos-anywhere/main/docs/logo.png" width="150" height="150">
<p><a href="./INDEX.html">Documentation Index</a></p>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>This guide documents a simple installation of NixOS using <strong>nixos-anywhere</strong> on
a target machine running x86_64 Linux with
<a href="https://man7.org/linux/man-pages/man8/kexec.8.html">kexec</a> support. The example
used in this guide installs NixOS on a Hetzner cloud machine. The configuration
may be different for some other instances. We will be including further examples
in the <a href="./howtos.html">How To Guide</a> as and when they are available.</p>
<p>You will need:</p>
<ul>
<li>A <a href="https://nixos.wiki/wiki/Flakes">flake</a> that controls the actions to be
performed</li>
<li>A disk configuration containing details of the file system that will be
created on the new server.</li>
</ul>
<p><strong>nixos-anywhere</strong> doesn’t need to be installed. You can run it directly from
<a href="https://github.com/numtide/nixos-anywhere">Numtide's repository on Github.</a></p>
<p>Details of the flake, the disk configuration and the CLI command are discussed
below.</p>
<h2 id="steps-required-to-run-nixos-anywhere"><a class="header" href="#steps-required-to-run-nixos-anywhere">Steps required to run nixos-anywhere</a></h2>
<ol>
<li>
<p><strong>Enable Flakes and Create a Directory</strong>:</p>
<ul>
<li>Ensure that flakes are enabled on your system. To enable flakes, refer to
the <a href="https://nixos.wiki/wiki/Flakes#enable-flakes">NixOS Wiki</a>.</li>
<li>Create a directory to store the flake and configuration files.</li>
</ul>
</li>
<li>
<p><strong>Initialize a Flake</strong>: Within the newly-created directory, execute the
command:</p>
<pre><code class="language-bash">nix flake init
</code></pre>
<p>This command will generate a <code>flake.nix</code> file. Modify this file according to
your requirements.</p>
<ul>
<li>
<p><strong>For a Minimal Setup</strong>:<br />
You can copy and paste the example flake contents available <a href="https://github.com/numtide/nixos-anywhere-examples/blob/main/flake.nix">here</a>.
This example is tailored for a virtual machine setup similar to one on <a href="https://www.hetzner.com/cloud">Hetzner Cloud</a>.</p>
<p><strong>Hardware-Specific Configuration</strong>: If you're not using a virtual machine,
you'll need to generate a custom hardware configuration with
<code>nixos-generate-config</code>.</p>
</li>
</ul>
</li>
</ol>
<ul>
<li>
<p><strong>Getting <code>nixos-generate-config</code> on Target Machine</strong>:</p>
<ol>
<li><strong>Option 1</strong>: If NixOS is not installed, boot into an installer without
first installing NixOS.</li>
<li><strong>Option 2</strong>: Use the kexec tarball method, as described
<a href="https://github.com/nix-community/nixos-images#kexec-tarballs">here</a>.</li>
</ol>
</li>
<li>
<p><strong>Generate Configuration</strong>: Run the following command on the target machine:</p>
<pre><code class="language-bash">nixos-generate-config --no-filesystems --root /mnt
</code></pre>
<p>This creates the necessary configuration files under <code>/mnt/etc/nixos/</code>, which
you can then customize as needed.</p>
</li>
</ul>
<ol start="3">
<li>
<p><strong>Find SSH Key Line</strong>:<br />
if you cloned
<a href="https://github.com/numtide/nixos-anywhere-examples/blob/main/flake.nix">our nixos-anywhere-example</a>
you will also replace the SSH key like this: In your configuration, locate
the line that reads:</p>
<pre><code class="language-bash"># change this to your ssh key
            &quot;CHANGE&quot;
</code></pre>
<p>Replace the text <code>CHANGE</code> with your own SSH key. This is crucial, as you will
not be able to log into the target machine post-installation without it.</p>
</li>
<li>
<p>In the same directory, create a file named <code>disk-config.nix</code>. This will be
used to specify the disk layout to the <strong>disko</strong> tool, which nixos-anywhere
uses to partition, format and mount the disks. Again, for a simple
installation you can paste the contents from the example
<a href="https://github.com/numtide/nixos-anywhere-examples/blob/main/disk-config.nix">here</a>.
This configures a standard GPT (GUID Partition Table) partition compatible
with both EFI and BIOS systems, and mounts the disk as <code>/dev/sda</code>. If this
doesn’t meet your requirements, choose an example that suits your disk layout
from the
<a href="https://github.com/nix-community/disko/tree/master/example">disko examples</a>.
For more information about this configuration, refer to the
<a href="https://github.com/nix-community/disko">disko documentation.</a></p>
</li>
<li>
<p>Run the following command to create the <code>flake.lock</code> file:</p>
</li>
</ol>
<pre><code>nix flake lock
</code></pre>
<p>Optionally, you can commit these files to a repo such as Github, or you can
simply reference your local directory when you run <strong>nixos-anywhere</strong>. This
example uses a local directory on the source machine.</p>
<ol start="6">
<li>
<p>On the target machine, make sure you have access as root via ssh by adding
your SSH key to the file <code>authorized_keys</code> in the directory <code>/root/.ssh</code></p>
</li>
<li>
<p>(Optional) Test your nixos and disko configuration:</p>
</li>
</ol>
<p>The following command will automatically test your nixos configuration and run
disko inside a virtual machine, where</p>
<ul>
<li>
<p><code>&lt;path to configuration&gt;</code> is the path to the directory or repository
containing <code>flake.nix</code> and <code>disk-config.nix</code></p>
</li>
<li>
<p><code>&lt;configuration name&gt;</code> must match the name that immediately follows the text
<code>nixosConfigurations.</code> in the flake, as indicated by the comment in the
<a href="https://github.com/numtide/nixos-anywhere-examples/blob/main/flake.nix">example</a>).</p>
</li>
</ul>
<pre><code>nix run github:numtide/nixos-anywhere -- --flake &lt;path to configuration&gt;#&lt;configuration name&gt; --vm-test
</code></pre>
<ol start="8">
<li>
<p>You can now run <strong>nixos-anywhere</strong> from the command line as shown below,
where:</p>
<ul>
<li>
<p><code>&lt;path to configuration&gt;</code> is the path to the directory or repository
containing <code>flake.nix</code> and <code>disk-config.nix</code></p>
</li>
<li>
<p><code>&lt;configuration name&gt;</code> must match the name that immediately follows the
text <code>nixosConfigurations.</code> in the flake, as indicated by the comment in
the
<a href="https://github.com/numtide/nixos-anywhere-examples/blob/main/flake.nix">example</a>).</p>
</li>
<li>
<p><code>&lt;ip address&gt;</code> is the IP address of the target machine.</p>
</li>
</ul>
</li>
</ol>
<pre><code>nix run github:numtide/nixos-anywhere -- --flake &lt;path to configuration&gt;#&lt;configuration name&gt; root@&lt;ip address&gt;
</code></pre>
<p>The command would look  like this if you had created your files in a directory
named <code>/home/mydir/test</code> and the IP address of your target machine is
<code>37.27.18.135</code>:</p>
<pre><code>nix run github:numtide/nixos-anywhere -- --flake /home/mydir/test#hetzner-cloud root@37.27.18.135
</code></pre>
<p><strong>nixos-anywhere</strong> will then run, showing various output messages at each stage.
It may take some time to complete, depending on Internet speeds. It should
finish by showing the messages below before returning to the command prompt.</p>
<pre><code>Installation finished. No error reported.
Warning: Permanently added '&lt;ip-address&gt;' (ED25519) to the list of known hosts
</code></pre>
<p>When this happens, the target server will have been overwritten with a new
installation of NixOS. Note that the server's public SSH key will have changed.</p>
<p>If you have previously accessed this server using SSH, you may see the following
message the next time you try to log in to the target.</p>
<pre><code>  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ED25519 key sent by the remote host is
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX.
Please contact your system administrator.
Add correct host key in ~/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in ~/.ssh/known_hosts:6
  remove with:
  ssh-keygen -f ~/.ssh/known_hosts&quot; -R &quot;&lt;ip addrress&gt;&quot;
Host key for &lt;ip_address&gt; has changed and you have requested strict checking.
Host key verification failed.
</code></pre>
<p>This is because the <code>known_hosts</code> file in the <code>.ssh</code> directory now contains a
mismatch, since the server has been overwritten. To solve this, use a text
editor to remove the old entry from the <code>known_hosts</code> file. The next connection
attempt will then treat this as a new server.</p>
<p>The error message line <code>Offending ECDSA key in ~/.ssh/known_hosts:</code> gives the
line number that needs to be removed from the <code>known_hosts</code> file.</p>
<p><strong>Note:</strong> If you subsequently make any changes to either the <code>flake.nix</code> or
<code>disk-config.nix</code> file, you will need to run the following command in the
directory containing the flake to update <code>flake.lock</code> before rerunning
<strong>nixos-anywhere</strong>:</p>
<pre><code>nix flake update
</code></pre>
<p>The new server's configurations are defined in the flake. <code>nixos-anywhere</code> does
not create <code>etc/nixos/configuration.nix</code>, since it expects the server to be
administered remotely. Any future changes to the configuration should be made to
the flake, and you would reference this flake when doing the nixos-rebuild
command or a deployment tool of your choice i.e.
<a href="https://github.com/zhaofengli/colmena">colmena</a>,
<a href="https://github.com/MatthewCroughan/nixinate">nixinate</a>.</p>
<p>This example can be run from the machine itself for updating (replace
<code>&lt;URL to your flake&gt;</code> with your flake i.e. <code>.#</code> if your flake is in the current
directory):</p>
<pre><code>nixos-rebuild switch --flake &lt;URL to your flake&gt;
</code></pre>
<p>You can also run <code>nixos-rebuild</code> to update a machine remotly, if you have set up
an openssh server and your ssh key for the root user:</p>
<pre><code>nixos-rebuild switch --flake &lt;URL to your flake&gt; --target-host &quot;root@&lt;ip address&gt;&quot;
</code></pre>
<p>For more information on different use cases of <strong>nixos-anywhere</strong> please refer
to the <a href="./howtos.html">How to Guide</a>, and for more technical information and
explanation of known error messages, refer to the
<a href="./reference.html">Reference Manual</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="system-requirements-nixos-anywhere"><a class="header" href="#system-requirements-nixos-anywhere">System Requirements: nixos-anywhere</a></h1>
<p><strong><em>Install NixOS everywhere via ssh</em></strong></p>
<img src="https://raw.githubusercontent.com/numtide/nixos-anywhere/main/docs/logo.png" width="150" height="150">
<p><a href="./INDEX.html">Documentation Index</a></p>
<h2 id="requirements"><a class="header" href="#requirements">Requirements</a></h2>
<ul>
<li>Source Machine:
<ul>
<li>Can be any Linux or Mac computer with Nix installed, or a NixOS machine.</li>
</ul>
</li>
<li>Destination Machine:
<ul>
<li>Must be an x86-64 machine unless you are able to supply a <code>kexec</code> image for
your CPU type.</li>
<li>If you're not using the option to boot from a Nixos installer image, it
must:
<ul>
<li>Be running x86-64 Linux with kexec support . Most x86_64 Linux systems do
have kexec support.</li>
<li>Have at least 1.5 GB of RAM, excluding swap.</li>
</ul>
</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-guide-nixos-anywhere"><a class="header" href="#how-to-guide-nixos-anywhere">How To Guide: nixos-anywhere</a></h1>
<p><strong><em>Install NixOS everywhere via ssh</em></strong></p>
<img title="" src="https://raw.githubusercontent.com/numtide/nixos-anywhere/main/docs/logo.png" alt="" width="129">
<p><a href="./INDEX.html">Documentation Index</a></p>
<h2 id="contents"><a class="header" href="#contents">Contents</a></h2>
<p><a href="howtos.html#installing-on-a-machine-with-no-operating-system">Installing on a machine with no operating system</a></p>
<p><a href="howtos.html#using-your-own-kexec-image">Using your own kexec image</a></p>
<p><a href="howtos.html#secrets-and-full-disk-encryption">Secrets and full disk encryption</a></p>
<p><a href="howtos.html#use-without-flakes">Use without flakes</a></p>
<h2 id="installing-on-a-machine-with-no-operating-system"><a class="header" href="#installing-on-a-machine-with-no-operating-system">Installing on a machine with no operating system</a></h2>
<p>If your machine doesn't currently have an operating system installed, you can
still run <code>nixos-anywhere</code> remotely to automate the install. To do this, you
would first need to boot the target machine from the standard NixOS installer.
You can either boot from a USB or use <code>netboot</code>.</p>
<p>The
<a href="https://nixos.org/manual/nixos/stable/index.html#sec-booting-from-usb">NixOS installation guide</a>
has detailed instructions on how to boot the installer.</p>
<p>When you run <code>nixos-anywhere</code>, it will determine whether a NixOS installer is
present by checking whether the <code>/etc/os-release</code> file contains the identifier
<code>VARIANT=installer</code>. This identifier is available on releases NixOS 23.05 or
later.</p>
<p>If an installer is detected, <code>nixos-anywhere</code> will not attempt to <code>kexec</code> into
its own image. This is particularly useful for targets that don't have enough
RAM for <code>kexec</code> or don't support <code>kexec</code>.</p>
<p>NixOS starts an SSH server on the installer by default, but you need to set a
password in order to access it. To set a password for the <code>nixos</code> user, run the
following command in a terminal on the NixOS machine:</p>
<pre><code>passwd
</code></pre>
<p>If you don't know the IP address of the installer on your network, you can find
it by running the following command:</p>
<pre><code>$ ip addr
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 52:54:00:12:34:56 brd ff:ff:ff:ff:ff:ff
    altname enp0s3
    altname ens3
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic noprefixroute eth0
       valid_lft 86385sec preferred_lft 75585sec
    inet6 fec0::5054:ff:fe12:3456/64 scope site dynamic mngtmpaddr noprefixroute
       valid_lft 86385sec preferred_lft 14385sec
    inet6 fe80::5054:ff:fe12:3456/64 scope link
       valid_lft forever preferred_lft forever
</code></pre>
<p>This will display the IP addresses assigned to your network interface(s),
including the IP address of the installer. In the example output below, the
installer's IP addresses are <code>10.0.2.15</code>, <code>fec0::5054:ff:fe12:3456</code>, and
<code>fe80::5054:ff:fe12:3456%eth0</code>:</p>
<p>To test if you can connect and your password works, you can use the following
SSH command (replace the IP address with your own):</p>
<pre><code>ssh -v nixos@fec0::5054:ff:fe12:3456
</code></pre>
<p>You can then use the IP address to run <code>nixos-anywhere</code> like this:</p>
<pre><code>nix run github:numtide/nixos-anywhere -- --flake '.#myconfig' nixos@fec0::5054:ff:fe12:3456
</code></pre>
<p>This example assumes a flake in the curent directory containing a configuration
named <code>myconfig</code>.</p>
<h2 id="using-your-own-kexec-image"><a class="header" href="#using-your-own-kexec-image">Using your own kexec image</a></h2>
<p>By default, <code>nixos-anywhere</code> downloads the kexec image from the
<a href="https://github.com/nix-community/nixos-images#kexec-tarballs">NixOS images repository</a>.</p>
<p>However, you can provide your own <code>kexec</code> image file if you need to use a
different one. This is particularly useful for architectures other than <code>x86_64</code>
and <code>aarch64</code>, since they don't have a pre-build image.</p>
<p>To do this, use the <code>--kexec</code> command line switch followed by the path to your
image file. The image will be uploaded prior to execution.</p>
<p>Here's an example command that demonstrates how to use a custom kexec image with
<code>nixos-anywhere</code>:</p>
<pre><code>nix run github:numtide/nixos-anywhere -- \
  --kexec &quot;$(nix build --print-out-paths github:nix-community/nixos-images#packages.aarch64-linux.kexec-installer-nixos-unstable-noninteractive)/nixos-kexec-installer-noninteractive-aarch64-linux.tar.gz&quot; \
  --flake 'github:your-user/your-repo#your-system' \
  root@yourip
</code></pre>
<p>Make sure to replace <code>github:your-user/your-repo#your-system</code> with the
appropriate Flake URL representing your NixOS configuration.</p>
<p>The example above assumes that your local machine can build for aarch64 in one
of the following ways:</p>
<ul>
<li>
<p>Natively</p>
</li>
<li>
<p>Through a remote builder</p>
</li>
<li>
<p>By emulating the architecture with qemu using the following NixOS
configuration:</p>
</li>
</ul>
<pre><code class="language-nix">{
  boot.binfmt.emulatedSystems = [ &quot;aarch64-linux&quot; ];
}
</code></pre>
<h2 id="secrets-and-full-disk-encryption"><a class="header" href="#secrets-and-full-disk-encryption">Secrets and full disk encryption</a></h2>
<p>The <code>nixos-anywhere</code> utility offers the capability to install secrets onto a
target machine. This feature is particularly beneficial when you want to
bootstrap secrets management tools such as
<a href="https://github.com/Mic92/sops-nix">sops-nix</a> or
<a href="https://github.com/ryantm/agenix">agenix</a>, which rely on machine-specific
secrets to decrypt other uploaded secrets.</p>
<h3 id="example-decrypting-an-openssh-host-key-with-pass"><a class="header" href="#example-decrypting-an-openssh-host-key-with-pass">Example: Decrypting an OpenSSH Host Key with pass</a></h3>
<p>In this example, we demonstrate how to use a script to decrypt an OpenSSH host
key from the <code>pass</code> password manager and subsequently pass it to
<code>nixos-anywhere</code> during the installation process:</p>
<pre><code class="language-bash">#!/usr/bin/env bash

# Create a temporary directory
temp=$(mktemp -d)

# Function to cleanup temporary directory on exit
cleanup() {
  rm -rf &quot;$temp&quot;
}
trap cleanup EXIT

# Create the directory where sshd expects to find the host keys
install -d -m755 &quot;$temp/etc/ssh&quot;

# Decrypt your private key from the password store and copy it to the temporary directory
pass ssh_host_ed25519_key &gt; &quot;$temp/etc/ssh/ssh_host_ed25519_key&quot;

# Set the correct permissions so sshd will accept the key
chmod 600 &quot;$temp/etc/ssh/ssh_host_ed25519_key&quot;

# Install NixOS to the host system with our secrets
nixos-anywhere --extra-files &quot;$temp&quot; --flake '.#your-host' root@yourip
</code></pre>
<h3 id="example-uploading-disk-encryption-secrets"><a class="header" href="#example-uploading-disk-encryption-secrets">Example: Uploading Disk Encryption Secrets</a></h3>
<p>In a similar vein, <code>nixos-anywhere</code> can upload disk encryption secrets, which
are necessary during formatting with disko. Here's an example that demonstrates
how to provide your disk encryption password as a file or via the <code>pass</code> utility
to <code>nixos-anywhere</code>:</p>
<pre><code class="language-bash"># Write your disk encryption password to a file
echo &quot;my-super-safe-password&quot; &gt; /tmp/disk-1.key

# Call nixos-anywhere with disk encryption keys
nixos-anywhere \
  --disk-encryption-keys /tmp/disk-1.key /tmp/disk-1.key \
  --disk-encryption-keys /tmp/disk-2.key &lt;(pass my-disk-encryption-password) \
  --flake '.#your-host' \
  root@yourip
</code></pre>
<p>In the above example, replace <code>&quot;my-super-safe-password&quot;</code> with your actual
encryption password, and <code>my-disk-encryption-password</code> with the relevant entry
in your pass password store. Also, ensure to replace <code>'.#your-host'</code> and
<code>root@yourip</code> with your actual flake and IP address, respectively.</p>
<h2 id="use-without-flakes"><a class="header" href="#use-without-flakes">Use without flakes</a></h2>
<p>While <code>nixos-anywhere</code> is designed to work optimally with Nix Flakes, it also
supports the traditional approach without flakes. This document outlines how to
use <code>nixos-anywhere</code> without relying on flakes.</p>
<h3 id="generate-required-store-paths"><a class="header" href="#generate-required-store-paths">Generate Required Store Paths</a></h3>
<p>Before you can use <code>nixos-anywhere</code> without flakes, you'll need to manually
generate the paths for the NixOS system toplevel and disk image. The paths are
generated using <code>nix-build</code> and are necessary for executing <code>nixos-anywhere</code>.</p>
<h4 id="generating-nixos-system-toplevel"><a class="header" href="#generating-nixos-system-toplevel">Generating NixOS System Toplevel:</a></h4>
<p>Execute the following command to generate the store path for the NixOS system
toplevel:</p>
<pre><code class="language-bash">nix-build -I nixos-config=/etc/nixos/configuration.nix -E '(import &lt;nixpkgs/nixos&gt; {}).config.system.build.toplevel'
</code></pre>
<p>This will output a path in <code>/nix/store</code> that corresponds to the system toplevel,
which includes all the software and configurations for the system. Make note of
this path for later use.</p>
<h4 id="generating-disk-image-without-dependencies"><a class="header" href="#generating-disk-image-without-dependencies">Generating Disk Image without Dependencies:</a></h4>
<p>To generate the disk image without dependencies, execute:</p>
<pre><code class="language-bash">nix-build -I nixos-config=/etc/nixos/configuration.nix -E '(import &lt;nixpkgs/nixos&gt; {}).config.system.build.diskNoDeps'
</code></pre>
<p>This will also output a script path in <code>/nix/store</code> that will format your disk.
Keep this path handy as well.</p>
<h3 id="running-nixos-anywhere"><a class="header" href="#running-nixos-anywhere">Running NixOS-Anywhere</a></h3>
<p>With both paths in hand, you can execute <code>nixos-anywhere</code> as follows:</p>
<pre><code class="language-bash">nixos-anywhere --store-paths /nix/store/[your-toplevel-path] /nix/store/[your-disk-image-path]
</code></pre>
<p>Replace <code>[your-toplevel-path]</code> and <code>[your-disk-image-path]</code> with the
corresponding store paths you generated earlier.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="support-matrix-nixos-anywhere"><a class="header" href="#support-matrix-nixos-anywhere">Support Matrix: nixos-anywhere</a></h1>
<p><strong><em>Install NixOS everywhere via ssh</em></strong></p>
<img src="https://raw.githubusercontent.com/numtide/nixos-anywhere/main/docs/logo.png" width="150" height="150">
<p><a href="./INDEX.html">Documentation Index</a></p>
<h2 id="list-of-tested-environments"><a class="header" href="#list-of-tested-environments">List of tested environments</a></h2>
<p>We have verified that <strong>nixos-anywhere</strong> runs successfully on the environments
listed below.</p>
<p><strong>kexec boot:</strong>    Indicates whether it can work by using a kexec boot</p>
<p><strong>Image boot:</strong> Indicates whether it can work if booted from a NixOS installer</p>
<p><strong>Own kexec:</strong>     Indicates whether it can work if you supply your own kexec</p>
<div class="table-wrapper"><table><thead><tr><th><strong>Platform</strong></th><th><strong>Operating System</strong></th><th>kexec boot</th><th>Image boot</th><th>Own kexec</th></tr></thead><tbody>
<tr><td>Hetzner Cloud</td><td>X86-64 Linux</td><td>Yes</td><td>Yes</td><td>Yes</td></tr>
<tr><td></td><td></td><td></td><td></td><td></td></tr>
<tr><td></td><td></td><td></td><td></td><td></td></tr>
<tr><td></td><td></td><td></td><td></td><td></td></tr>
<tr><td></td><td></td><td></td><td></td><td></td></tr>
<tr><td></td><td></td><td></td><td></td><td></td></tr>
<tr><td></td><td></td><td></td><td></td><td></td></tr>
</tbody></table>
</div>
<h2 id=""><a class="header" href="#"></a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reference-manual-nixos-anywhere"><a class="header" href="#reference-manual-nixos-anywhere">Reference Manual: nixos-anywhere</a></h1>
<p><strong><em>Install NixOS everywhere via ssh</em></strong></p>
<img title="" src="https://raw.githubusercontent.com/numtide/nixos-anywhere/main/docs/logo.png" alt="" width="141">
<p><a href="./INDEX.html">Documentation Index</a></p>
<p>TODO: Populate this guide properly</p>
<h2 id="contents-1"><a class="header" href="#contents-1">Contents</a></h2>
<p><a href="reference.html#command-line-usage">Command Line Usage</a></p>
<p><a href="reference.html#explanation-of-known-error-messages">Explanation of known error messages</a></p>
<h2 id="command-line-usage"><a class="header" href="#command-line-usage">Command Line Usage</a></h2>
<!-- `$ bash ./src/nixos-anywhere.sh --help` -->
<pre><code>Usage: nixos-anywhere [options] &lt;ssh-host&gt;

Options:

* -f, --flake &lt;flake_uri&gt;
  set the flake to install the system from.
* -i &lt;identity_file&gt;
  selects which SSH private key file to use.
* -L, --print-build-logs
  print full build logs
* -s, --store-paths &lt;disko-script&gt; &lt;nixos-system&gt;
  set the store paths to the disko-script and nixos-system directly
  if this is give, flake is not needed
* --no-reboot
  do not reboot after installation, allowing further customization of the target installation.
* --kexec &lt;url&gt;
  use another kexec tarball to bootstrap NixOS
* --stop-after-disko
  exit after disko formating, you can then proceed to install manually or some other way
* --extra-files &lt;file...&gt;
  files to copy into the new nixos installation
* --disk-encryption-keys &lt;remote_path&gt; &lt;local_path&gt;
  copy the contents of the file or pipe in local_path to remote_path in the installer environment,
  after kexec but before installation. Can be repeated.
* --no-substitute-on-destination
  disable passing --substitute-on-destination to nix-copy
* --debug
  enable debug output
* --option &lt;key&gt; &lt;value&gt;
  nix option to pass to every nix related command
* --from &lt;store-uri&gt;
  URL of the source Nix store to copy the nixos and disko closure from
* --build-on-remote
  build the closure on the remote machine instead of locally and copy-closuring it
</code></pre>
<h2 id="explanation-of-known-error-messages"><a class="header" href="#explanation-of-known-error-messages">Explanation of known error messages</a></h2>
<p>TODO: Add additional error messages and meanings. Fill in missing explanations</p>
<p>This section lists known error messages and their explanations. Some
explanations may refer to the following CLI syntax:</p>
<p><code>nix run github:numtide/nixos-anywhere -- --flake &lt;path to configuration&gt;#&lt;configuration name&gt; root@&lt;ip address&gt;</code></p>
<p>This list is not comprehensive. It's possible you may encounter errors that
originate from the underlying operating system. These should be documented in
the relevant operating system manual.</p>
<div class="table-wrapper"><table><thead><tr><th>Id</th><th>Message</th><th>Explanation</th></tr></thead><tbody>
<tr><td>1</td><td>Failure unpacking initrd</td><td>You don't have enough RAM to hold <code>kexec</code></td></tr>
<tr><td>2</td><td>Flake &lt;flake_url&gt; does not provide attirbute</td><td>The configuration name you specified in your flake URI is not defined as a NixOS configuration in your flake eg if your URI was mydir#myconfig, then myconfig should be included in the flake as <code>nixosConfigurations.myconfig</code></td></tr>
<tr><td>3</td><td>Please specify the name of the NixOS configuration to be installed, as a URI fragment in the flake-uri.</td><td>As for error #2</td></tr>
<tr><td></td><td>For example, to use the output nixosConfigurations.foo from the flake.nix, append &quot;#foo&quot; to the flake-uri</td><td></td></tr>
<tr><td>4</td><td>Retrieving host facts via ssh failed. Check with --debug for the root cause, unless you have done so already</td><td>TODO: Explain</td></tr>
<tr><td>5</td><td>ssh-host must be set</td><td>&lt;ip_address&gt; has not been supplied</td></tr>
<tr><td>6</td><td>&lt;disko_script&gt; and &lt;nixos_system&gt; must be existing store-paths</td><td>This occurs if the -s switch has been used to specify the disko script and store path correctly, and the scripts cannot be found at the given URI</td></tr>
<tr><td>7</td><td>flake must be set</td><td>This occurs if both the -flake option (use a flake) and the -s option (specify paths directly) have been omitted. Either one or the other must be specified.</td></tr>
<tr><td>8</td><td>no tar command found, but required to unpack kexec tarball</td><td>The destination machine does not have a <code>tar</code> command available. This is needed to unpack the <code>kexec</code>.</td></tr>
<tr><td>9</td><td>no setsid command found, but required to run the kexec script under a new session</td><td>The destination machine does not have the <code>setsid</code> command available</td></tr>
<tr><td>10</td><td>This script requires Linux as the operating system, but got <operating system></td><td>The destination machine is not running Linux</td></tr>
<tr><td>11</td><td>The default kexec image only support x86_64 cpus. Checkout https://github.com/numtide/nixos-anywhere/#using-your-own-kexec-image for more information.</td><td>By default, <code>nixos-anywhere</code> uses its own <code>kexec</code> image, which will only run on x86_64 CPUs. For other CPU types, you can use your own <code>kexec</code> image instead. Refer to the <a href="./howtos#using-your-own-kexec-image">How To Guide</a> for instructions.</td></tr>
<tr><td>12</td><td>Please specify the name of the NixOS configuration to be installed, as a URI fragment in the flake-uri.</td><td>This is a <code>disko</code> error. As for Error #2</td></tr>
<tr><td></td><td>For example, to use the output diskoConfigurations.foo from the flake.nix, append &quot;#foo&quot; to the flake-uri.</td><td></td></tr>
<tr><td>13</td><td>mode must be either create, mount or zap_create_mount</td><td>This is a <code>disko</code> error. The <code>disko</code> switches have not been used correctly. This could happen if you supplied your own <code>disko</code> script using the -s option</td></tr>
<tr><td>14</td><td>disko config must be an existing file or flake must be set</td><td>This is a <code>disko</code> error. This will happen if the <code>disko.devices</code> entry in your flake doesn't match the name of a file in the same location as your flake.</td></tr>
<tr><td></td><td></td><td></td></tr>
<tr><td></td><td></td><td></td></tr>
<tr><td></td><td></td><td></td></tr>
<tr><td></td><td></td><td></td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
